local TweenService = game:GetService("TweenService")
local uis = game:GetService("UserInputService")
local Players = game:GetService("Players")

local tweendebounce = false
local start = tick() 
local timerplay = false
local checkpoint = "none"
local currentObby = nil
local LightingChange = true
local isHoldingR = false
local holdCooldownR = false
local dest = nil
local Sound = game.Players:GetPlayerFromCharacter(script.Parent).PlayerGui.PlayingMusic
Sound.Playing = true
local CurrentMusicPriority = 0 - math.huge
local CurrentSoundId = "3343586026"
local CurrentMusicPart = nil

local function resetLightings()
	game.Lighting.Ambient = Color3.fromRGB(0,0,0)
	game.Lighting.Brightness = 2
	game.Lighting.ClockTime = 16
	game.Lighting.ColorShift_Bottom = Color3.fromRGB(0, 0, 0)
	game.Lighting.ColorShift_Top = Color3.fromRGB(0, 0, 0)
	game.Lighting.EnvironmentDiffuseScale = 1
	game.Lighting.EnvironmentSpecularScale = 1
	game.Lighting.GeographicLatitude = 0
	game.Lighting.GlobalShadows = true
	game.Lighting.OutdoorAmbient = Color3.fromRGB(70, 70, 70)
	game.Lighting.ShadowSoftness = 0.2
	game.Lighting.FogColor = Color3.fromRGB(192, 192, 192)
	game.Lighting.FogEnd = 2000
	game.Lighting.FogStart = 30
end

function tween(used,Time,inf)
	local tweeninf=TweenInfo.new(
		Time,
		Enum.EasingStyle.Linear,
		Enum.EasingDirection.Out
	)
	local tw=TweenService:Create(used,tweeninf,inf)
	tw:Play()
end


script.Parent:WaitForChild("Humanoid").Died:Connect(function()
	timerplay = false
	dest = nil
	checkpoint = "none"
	currentObby = nil
	resetLightings()
end)


script.Parent:WaitForChild("Humanoid").Touched:connect(function(hit)
	if hit and hit:IsA("BasePart") and hit.Name == "KillPart" and hit:FindFirstChild("kills"):IsA("BoolValue") and script.Parent:FindFirstChild("Humanoid") then
		if hit:FindFirstChild("kills").Value == true then
			game:GetService("ReplicatedStorage").DamageEvent:FireServer(script.Parent:WaitForChild("Humanoid"), math.huge) -- scary number uwu
		else
			game:GetService("ReplicatedStorage").DamageEvent:FireServer(script.Parent:WaitForChild("Humanoid"), 5)
		end


	elseif hit and hit:IsA("Part") and hit.Name == "SpeedPart" and hit:FindFirstChild("speed") and hit.speed:IsA("NumberValue") and hit:FindFirstChild("time") and hit.time:IsA("NumberValue") and script.Parent:FindFirstChild("Humanoid") then
		script.Parent:FindFirstChild("Humanoid").WalkSpeed = hit.speed.Value
		
	elseif hit and hit:IsA("Part") and hit.Name == "JumpPart" and hit:FindFirstChild("jumpPower") and hit.jumpPower:IsA("NumberValue") and hit:FindFirstChild("time") and hit.time:IsA("NumberValue") and script.Parent:FindFirstChild("Humanoid") then
		script.Parent:FindFirstChild("Humanoid").JumpPower = hit.jumpPower.Value

	elseif hit and hit:IsA("Part") and hit.Name == "ResetSpeedPart" and script.Parent:FindFirstChild("Humanoid") then
		repeat script.Parent:FindFirstChild("Humanoid").WalkSpeed = 16 until script.Parent:FindFirstChild("Humanoid").WalkSpeed == 16


	elseif hit and hit:IsA("Part") and hit.Name == "Portal" and hit:FindFirstChild("Destination") and script.Parent:FindFirstChild("Humanoid") then
		script.Parent:SetPrimaryPartCFrame(CFrame.new(hit:FindFirstChild("Destination").Value.Position))
		game:GetService("Players"):GetPlayerFromCharacter(script.Parent).PlayerGui:FindFirstChild("UserInterface"):FindFirstChild("CurrentObby").Text = hit:FindFirstChild("Destination").Value:FindFirstChild("letters").Value
		game:GetService("Players"):GetPlayerFromCharacter(script.Parent).PlayerGui:FindFirstChild("UserInterface"):FindFirstChild("CurrentObby").Visible = true
		game:GetService("Players"):GetPlayerFromCharacter(script.Parent).PlayerGui:FindFirstChild("UserInterface"):FindFirstChild("TimerObby").Visible = true
		start = tick()
		timerplay = true
		currentObby = hit:FindFirstChild("Destination").Value:FindFirstChild("letters").Value
		checkpoint = "none"
		dest = hit:FindFirstChild("Destination").Value
		Sound.SoundId = "rbxassetid://"..hit:FindFirstChild("Destination").Value:FindFirstChild("SoundId").Value
		Sound.TimePosition = 0
		script.Parent.Humanoid.Health = 100
		script.Parent.Humanoid.WalkSpeed = 16
		script.Parent.Humanoid.JumpPower = 50


	elseif hit and hit:IsA("Part") and hit.Name == "CheckPoint" and script.Parent:WaitForChild("Humanoid") then
		if hit:FindFirstChild("Checkpoint") and hit.Checkpoint.Value == currentObby then
			checkpoint = hit.Checkpoint.Value
		end


	elseif hit and hit:IsA("Part") and hit.Name == "WinPad" and hit:FindFirstChild("ObbyName") and hit:FindFirstChild("Difficulty") and script.Parent:WaitForChild("Humanoid") then
		resetLightings()
		local wpletters = hit:FindFirstChild("ObbyLetters")
		if checkpoint == currentObby and checkpoint == wpletters.Value and currentObby == wpletters.Value then
			script.Parent:SetPrimaryPartCFrame(CFrame.new(game.Workspace.Map.WinningRoom.Destination.Position))
			game.Players.LocalPlayer.Team = game:GetService("Teams").Winner
			game:GetService("ReplicatedStorage"):FindFirstChild("MessageServerEvent"):FireServer(hit:FindFirstChild("ObbyName").Value, "pass", game.Players.LocalPlayer.Name, hit:FindFirstChild("Difficulty").Value, tostring(game:GetService("Players"):GetPlayerFromCharacter(script.Parent).PlayerGui:FindFirstChild("UserInterface"):FindFirstChild("TimerObby").Text))
			timerplay = false
			checkpoint = "none"
			currentObby = nil
			Sound.SoundId = "rbxassetid://3343586026"
			Sound.TimePosition = 0
		else
			game:GetService("ReplicatedStorage"):FindFirstChild("MessageServerEvent"):FireServer(hit:FindFirstChild("ObbyName").Value, "skip", game.Players.LocalPlayer.Name)
		end


	elseif hit and hit:IsA("Part") and hit.Name == "EndPad" and script.Parent:WaitForChild("Humanoid") then
		game.Players.LocalPlayer.Team = game:GetService("Teams").Player
		game:GetService("ReplicatedStorage").DamageEvent:FireServer(script.Parent:WaitForChild("Humanoid"), math.huge)


	elseif hit and hit:IsA("Part") and hit.Name == "LightChangerPart" and script.Parent:WaitForChild("Humanoid") then
		if script.Parent.Humanoid.Health >= 0.2 then
			game.Lighting.Ambient = hit.Ambient.Value
			game.Lighting.Brightness = hit.Brightness.Value
			game.Lighting.ClockTime = hit.ClockTime.Value
			game.Lighting.ColorShift_Bottom = hit.ColorShift_Bottom.Value
			game.Lighting.ColorShift_Top = hit.ColorShift_Top.Value
			game.Lighting.EnvironmentDiffuseScale = hit.EnvironmentDiffuseScale.Value
			game.Lighting.EnvironmentSpecularScale = hit.EnvironmentSpecularScale.Value
			game.Lighting.GeographicLatitude = hit.GeographicLatitude.Value
			game.Lighting.GlobalShadows = hit.GlobalShadows.Value
			game.Lighting.OutdoorAmbient = hit.OutdoorAmbient.Value
			game.Lighting.ShadowSoftness = hit.ShadowSoftness.Value
			game.Lighting.FogColor = hit.FogColor.Value
			game.Lighting.FogEnd = hit.FogEnd.Value
			game.Lighting.FogStart = hit.FogStart.Value
		else
			resetLightings()
		end
	elseif hit and hit:IsA("Part") and hit.Name == "LightResetPart" and script.Parent:WaitForChild("Humanoid") then
		resetLightings()

	elseif hit and hit:IsA("Part") and hit.Name == "Teleporter" and hit:WaitForChild("Destination") and hit:WaitForChild("Tween") and script.Parent:WaitForChild("Humanoid") then
		if hit:FindFirstChild("Tween") and hit.Tween.Value == false then
			script.Parent:SetPrimaryPartCFrame(CFrame.new(hit.Destination.Position + Vector3.new(0, 3, 0)))
			if hit:FindFirstChild("TeleportSound") then
				local TpSound = Instance.new("Sound", game.Players.LocalPlayer.PlayerGui)
				TpSound.SoundId = "rbxassetid://"..hit.TeleportSound.Value
				TpSound.Volume = 1
				TpSound:Play()
				TpSound.Ended:Wait()
				TpSound:Destroy()
			end
		else
			if not tweendebounce then
				tweendebounce = true
				script.Parent.HumanoidRootPart.Anchored = true
				TweenService:Create(script.Parent.HumanoidRootPart, TweenInfo.new(2, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {CFrame = CFrame.new(hit.Destination.Position + Vector3.new(0, 3, 0))}):Play()
				wait(2)
				script.Parent.HumanoidRootPart.Anchored = false
				tweendebounce = false
			end	
		end 
		
		

	elseif hit and hit:IsA("Part") and hit.Name == "Elevator_LookVector" and script.Parent:FindFirstChild("Humanoid") then
		local torso = script.Parent.Torso
		if not torso:FindFirstChild("ElevatorVelocity") then
			local speed = hit:FindFirstChild("Speed") and hit.Speed.Value
			local velocity = Instance.new("BodyVelocity", torso)
			velocity.Name = "ElevatorVelocity"
			velocity.MaxForce = Vector3.new(math.huge,math.huge,math.huge)
			--velocity.Velocity = Vector3.new(0,speed,0)
			velocity.Velocity = hit.CFrame.LookVector * speed
		end
		hit.TouchEnded:Connect(function()
			local torso = script.Parent.Torso
			if torso:FindFirstChild("ElevatorVelocity") and script.Parent:FindFirstChild("Humanoid") then torso.ElevatorVelocity:Destroy() end
			return script.Parent
		end)
		
		
	elseif hit and hit:IsA("Part") and hit.Name == "Elevator_Y" and script.Parent:FindFirstChild("Humanoid") then
		local torso = script.Parent.Torso
		if not torso:FindFirstChild("ElevatorVelocity") then
			local speed = hit:FindFirstChild("Speed") and hit.Speed.Value
			local velocity = Instance.new("BodyVelocity", torso)
			velocity.Name = "ElevatorVelocity"
			velocity.MaxForce = Vector3.new(0,math.huge,0)
			--velocity.Velocity = Vector3.new(0,speed,0)
			velocity.Velocity = Vector3.new(0, speed, 0)
		end
		hit.TouchEnded:Connect(function()
			local torso = script.Parent.Torso
			if torso:FindFirstChild("ElevatorVelocity") and script.Parent:FindFirstChild("Humanoid") then torso.ElevatorVelocity:Destroy() end
			return script.Parent
		end)
		
		
		
	elseif hit and hit:IsA("Part") and hit.Name == "MusicPart" and script.Parent:FindFirstChild("Humanoid") then
		local SongId = hit:FindFirstChild("SongId")
		local Priority = hit:FindFirstChild("Priority")
		
		if Priority.Value > CurrentMusicPriority then
			if CurrentSoundId ~= SongId.Value then
				CurrentMusicPriority = Priority.Value
				CurrentSoundId = SongId.Value
				CurrentMusicPart = hit
				tween(Sound, 1, {Volume = 0})
				wait(1)
				Sound:Stop()
				Sound.SoundId = "rbxassetid://"..SongId.Value
				Sound.TimePosition = 0
				Sound:Play()
				tween(Sound, 1, {Volume = 0.75})
			end
		else
			local Current_Magnitude = (script.Parent.HumanoidRootPart.Position - hit.Position).Magnitude
			local OLD_Magnitude = (script.Parent.HumanoidRootPart.Position - CurrentMusicPart.Position).Magnitude
			if Current_Magnitude < OLD_Magnitude + 1 then
				if CurrentSoundId ~= SongId.Value then
					CurrentMusicPriority = Priority.Value
					CurrentSoundId = SongId.Value
					CurrentMusicPart = hit
					tween(Sound, 1, {Volume = 0})
					wait(1)
					Sound:Stop()
					Sound.SoundId = "rbxassetid://"..SongId.Value
					Sound.TimePosition = 0
					Sound:Play()
					tween(Sound, 1, {Volume = 0.75})
				end
			end
		end
		
		
	end
end)




uis.InputBegan:Connect(function(key)
	if key.KeyCode==Enum.KeyCode.R and holdCooldownR == false then
		isHoldingR = true
		print("pressing the key R")
		--wait(3)
		for i = 3, 0, -0.05 do
			if isHoldingR == true and currentObby ~= nil and script.Parent:WaitForChild("Humanoid") then
				Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextTransparency = i/3
				Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextStrokeTransparency = i/3
				-- print(i)
				wait(0.05)
			end
		end
		if uis:IsKeyDown(Enum.KeyCode.R) and isHoldingR == true and holdCooldownR == false then
			print("R held for 3 seconds")
			if currentObby ~= nil and script.Parent:WaitForChild("Humanoid") then
				if script.Parent.Humanoid.Health >= 0.2 then
					print("yep man, stop pressing F9, this is just a test.")
					timerplay = false
					script.Parent:SetPrimaryPartCFrame(CFrame.new(dest.Position))
					wait()
					script.Parent.Humanoid.Health = 100
					resetLightings()
					script.Parent.Humanoid.WalkSpeed = 16
					script.Parent.Humanoid.JumpPower = 50
					checkpoint = "none"
					start = tick()
					timerplay = true
					Sound.SoundId = "rbxassetid://"..dest:FindFirstChild("SoundId").Value
					Sound.TimePosition = 0
					Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextTransparency = 1
					Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextStrokeTransparency = 1
				end
			end
		end
	end
end)

uis.InputEnded:Connect(function(key)
	if key.KeyCode==Enum.KeyCode.R and holdCooldownR == false then
		isHoldingR = false
		holdCooldownR = true
		repeat Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextTransparency = 1; Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextStrokeTransparency = 1 wait() until Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextTransparency == 1 and Players.LocalPlayer.PlayerGui.UserInterface.RespawnGUI.TextStrokeTransparency == 1
		wait(3)
		holdCooldownR = false
	end
end)


while true do
	wait()
	if timerplay then
		local diff = tick() - start
		local min = math.floor(diff / 60)
		local sec = diff - min*60
		local mil = math.floor((sec - math.floor(sec)) * 100)
		sec = math.floor(sec)
		game:GetService("Players"):GetPlayerFromCharacter(script.Parent).PlayerGui:FindFirstChild("UserInterface"):FindFirstChild("TimerObby").Text = min..":"..sec.."."..mil
	end
end
